<!--
	crop - use your browser to crop images
	Copyright (C) 2016  Marco Kühnel <kuehnel@codecivil.de>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<html lang="de">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="robots" content="index,follow"/>
        <title>crop - by codecivil</title>
        <style>

			* { 
			  border-radius:5px;
			  -moz-border-radius:5px;
			  -webkit-transition: all 0.2s ease;
			  -moz-transition: all 0.2s ease;
			  -ms-transition: all 0.2s ease;
			  -o-transition: all 0.2s ease;
			  transition: all 0.2s ease;
			}
			  

			h1, label, div, p, li, button { 
				font-family: Lucida Grande, Geneva, Arial, Verdana, Tahoma;
			   }
			h1 { text-align: center; }
			
			#crop_wrapper { 
				position: absolute;
				top: 10%;
				left: 50%;
				margin-right: -50%;
				width: 810px;
				padding: 20;
				transform: translate(-50%, 0);
				-webkit-transform: translate(-50%, 0);
				background-color: #b0d3ff;
				line-height: 2em;
				text-align: center;
				}		


			#img_upload {
				padding: 10px;
				}

			#custom_form,#result {
				padding: 10px;
				background-color: #c1e5ff;
				}	
				
			#inprogress { 
				display: none; 
				background-color: #d2f6ff;
				margin: 10px;
				padding: 5px;
				text-align: justify;
				line-height: 1.5em;
				}
				
			#info { 
				background-color: #d2f6ff;
				margin: 10px;
				text-align: justify;
				line-height: 1.5em;
				}
				
			#info_wrapper:hover { cursor: pointer; }
				
			#info_wrapper { 
				background-color: #d2f6ff;
				margin: 10px;
				padding: 5px;
				text-align: left;
				line-height: 1.5em;
				}

			#impressum_wrapper {
				background-color: #ffffff;
				position: fixed;
				top: 0;
				bottom: 0;
				right: 0;
				font-size: small; 
				color: #999999;
				margin: 5px;
				padding: 5px;
				line-height: 1.5em;
				z-index: 5;
				overflow: auto;
				}
				
			#impressum_wrapper:hover { cursor: pointer; }
			
			#impressum {
				text-align: left;
			}
			#impressum_title {
				text-align: right;
			}
		</style>
        <script type="text/javascript">
			/*crop a certain area of a certain image
			*
			* n: n-th file
			* imgfiles: user given file list in file input
			* result: id of result element
			* inprogress: id of element saying "in progress"
			* style: user chosen crop style
			* width,height: picture target format
			* cut: number of cut proposal
			* callback: callback function (here: use finished() )
			*/ 
			function crop_image_cut (n, imgfiles, result, inprogress, style, width, height, cut, callback) {
					document.getElementById(inprogress).style.display = "block";
					if (!cut) { cut = 0; }
					var imgfile = imgfiles[n];
					var img = new Image();
					img.src = window.URL.createObjectURL(imgfile);
					img.onload = function () {
						var _factor = Math.max( width / img.width, height / img.height );
						//recompute maximal number of cuts in width and height
						var w_max = Math.floor(2*img.width*_factor/width)-2;
						var h_max = Math.floor(2*img.height*_factor/height)-2;
						if (h_max < 0) { h_max = 0; };
						if (w_max < 0) { w_max = 0; };
						var w_cut = Math.min(w_max,cut); var h_cut = Math.min(h_max,cut);
						//create canvas, cut and resize
						var canvas = document.createElement('canvas');
						var ctx = canvas.getContext('2d');
						if ( width > 0 && height > 0 ) {
							canvas.width = width; canvas.height = height;
							//cut every half frame... (factor 2) //image might be too big, so try...
							try { ctx.drawImage(img,w_cut*width/(2*_factor),h_cut*height/(2*_factor),width/_factor,height/_factor,0,0,width,height); } catch(err) { document.getElementById(result).innerHTML += imgfile.name + ": Leider zu groß für den Browser.<br />"; callback(100,inprogress); return;}
						} else {	
							canvas.width = img.width * _factor; canvas.height = img.height * _factor;
							try { ctx.drawImage(img,0,0,img.width,img.height,0,0,img.width * _factor,img.height * _factor); } catch(err) { document.getElementById(result).innerHTML += imgfile.name + ": Leider zu groß für den Browser.<br />"; callback(100,inprogress); return;}
						}
						//create URL and anchor from canvas
						var new_img_url = canvas.toDataURL();
						var new_img = new Image();
						new_img.src = new_img_url;
						new_anchor = document.createElement('a');
						new_anchor.href = new_img_url;
							//create new file name
							new_prefix = imgfile.name.substring(0,imgfile.name.indexOf('.'));
							if ( style == "custom" ) {
								new_img_name = new_prefix + "_" + style + "_" + width + "x" + height + ".png";
							} else {
								new_img_name = new_prefix + "_" + style + ".png";
							} 
							//
						new_anchor.download = new_img_name;
						new_anchor.appendChild(new_img);
						//create result display
						var saved_space = Math.round(100-75*new_img_url.length/imgfile.size);
						if ( saved_space > 0 ) {
							document.getElementById(result).innerHTML += imgfile.name + ": Um <strong>" + saved_space + "&#37;</strong> reduzierte Dateigröße.<br />";
						} else {
							document.getElementById(result).innerHTML += imgfile.name + ": spart nichts ein. Verwenden Sie nach Möglichkeit das Originalbild.<br />";
						}
						document.getElementById(result).appendChild(new_anchor);
						document.getElementById(result).innerHTML += "<br /><br />";
						if ( h_cut == h_max && w_cut == w_max ) { callback(saved_space,inprogress); }			
					}
				}
			
			/*determine the number of necessary cuts for a certain image
			* and call the callback function
			*
			* n: n-th file
			* imgfiles: user given file list in file input
			* result: id of result element
			* inprogress: id of element saying "in progress"
			* style: user chosen crop style
			* width,height: picture target format
			* callback: callback function
			*/ 
			function determine_max_repeat(n,imgfiles,result,inprogress,style,width,height,callback) {
					var imgfile = imgfiles[n];
					var img = new Image();
					var w_max,h_max;
					img.src = window.URL.createObjectURL(imgfile);
					img.onload = function () {
						var _factor = Math.max( width / img.width, height / img.height );
						//cut after half a width/height, i.e. overlapping cuts
						w_max = Math.floor(2*img.width*_factor / width)-1;
						h_max = Math.floor(2*img.height*_factor/height)-1;
						//
						if (h_max < 1) { h_max = 1; }
						if (w_max < 1) { w_max = 1; }	
						//necessary cuts: w_max*hmax ( = Math.max(w_max,h_max) )
						callback(n,imgfiles,result,inprogress,style,width,height,w_max*h_max);
					}
				}
			
			/*the callback function used in determine_max_repeat:
			* generate the picture sequence of cuts for a certain image
			*
			* i: i-th file
			* imgfiles: user given file list in file input
			* result: id of result element
			* inprogress: id of element saying "in progress"
			* style: user chosen crop style
			* width,height: picture target format
			* value: number of cuts to be generated
			*/ 
			function crop_image(i,imgfiles,result,inprogress,style,width,height,value) { for ( var k = 0; k < value; k++ ) { crop_image_cut(i,imgfiles,result,inprogress,style,width,height,k,finished); }; }

			/*the callback function used in crop_image_cut:
			* stop to display "in progress"
			* 
			* value: some unused value (here: saved_space), generated at the end of image processing (s.th. the callback function of crop_image_cut waits until it is available!)
			* inprogress: id of element saying "in progress"
			*/
			function finished(value,inprogress) { document.getElementById(inprogress).style.display = "none"; }

			/*crop a sequence of files according to given style
			*
			* filelist: id of file input element
			* style_selection: id of style select element
			* el_width, el_height: the ids of the number input elements determining custom width and height
			* inprogress: id of the element showing "in progress"
			* result: id of element for displaying the result
			*/
			function crop(filelist, style_selection, el_width, el_height, inprogress, result) {
				document.getElementById(result).innerHTML = "";
				var style = document.getElementById(style_selection).value;
				var width, height;
				switch(style) {
					case "news":
						width = 225; height = 155; break;
					case "medium":
						width = 395; height = -1; break;
					case "large":
						width = 790; height = -1; break;
					case "custom":
						width = document.getElementById(el_width).value || -1; height = document.getElementById(el_height).value || -1;
					}
				if ( width <= 0 && height <= 0 ) { return false; }
				if ( width <= -2 || height <= -2 ) { return false; }				
				var imgfiles = document.getElementById(filelist).files;
				if ( navigator.userAgent.indexOf('Firefox') == -1 && navigator.userAgent.indexOf('Chrom') == -1 ) {
					document.getElementById(result).innerHTML += "Zum Speichern bitte das Bild rechtsklicken.<br />";
				} else {
					document.getElementById(result).innerHTML += "Zum Speichern bitte das Bild anklicken.<br />";
				}
				for ( var i = 0; i < imgfiles.length; i++ ) {
						determine_max_repeat(i,imgfiles,result,inprogress,style,width,height,crop_image);
					}
				}
	</script>
	</head>
	
	<body>
		<h1>crop</h1>
		<div id="impressum_wrapper" onclick="toggleEl('impressum');">
			<div id="impressum_title">Impressum</div>
			<div id="impressum">
				Angaben gemäß § 5 TMG:<br />
				Dr. Marco Kühnel<br />
				codecivil Dr. Marco Kühnel ICT Services<br />
				Vechteweg 4<br />
				30539 Hannover<br />
				<br />
				Kontakt:<br />
				Telefon: 	+49 (0) 170 7507391<br />
				E-Mail: 	kuehnel@codecivil.de<br />
				<br />
				Umsatzsteuer-ID:<br />
				Umsatzsteuer-Identifikationsnummer gemäß §27 a Umsatzsteuergesetz:<br />
				DE 296 659 690<br />
				Finanzamt Hannover-Mitte<br />
				<br />
				Verantwortlich für den Inhalt nach § 55 Abs. 2 RStV:<br />
				Dr. Marco Kühnel<br />
				Vechteweg 4<br />
				30539 Hannover <br />
			</div>
		</div>
		<div id="crop_wrapper">
			<div id="info_wrapper" onclick="toggleEl('info');"><strong>Info</strong>
				<div id="info">
					<p>Mit <strong>crop - by codecivil</strong> können Sie Bilder zum Gebrauch für Homepages, e-Mails oder 
					andere Webanwendungen zurechtschneiden. Oft werden dabei mehr als 90% Dateigröße eingespart, was
					nicht nur den einmaligen Datenverkehr beim Versenden der e-Mail oder beim Hochladen auf die Homepage
					verringert, sondern dies auch jedesmal, wenn jemand die das Bild enthaltende Webseite besucht. Dies spart <strong>Energie</strong>
					und <strong>Bandbreite</strong> in nicht unerheblichem Ausmaß.</p> 
					<p>Diese Seite funktioniert offline. Das heißt, die gesamte Bildbearbeitung läuft auf Ihrem Rechner,
					es werden keine Daten auf andere Server hochgeladen und damit Ihre <strong>Privatsphäre</strong> geschützt.</p>
					<p>Die gesamte Software besteht aus diesem einzigen File, das unter der <a href="https://github.com/codecivil/crop/blob/master/LICENSE">GNU Public License</a> lizensiert ist.
					Die neueste Version ist unter <a href="https://github.com/codecivil/crop">https://github.com/codecivil/crop</a> erhältlich. Diese "Offenheit" von Software stärkt <strong>Transparenz</strong>
					und <strong>Sicherheit</strong> im digitalen Bereich.</p>  
					<p>Um die Seite offline zu nutzen, rechtsklicken Sie auf eine freie Stelle der Seite und wählen Sie "Seite speichern unter..." aus. Danach können Sie jederzeit das heruntergeladene
					File index.html mit dem Browser öffnen und alle Funktionen nutzen.</p>
					
					Features:
					<ul>
					<li>Batch Processing: Sie können mehrere Bilder auf einmal bearbeiten</li>
					<li>Voreingestellte Optionen, die für viele Webanwendungen passend sind</li>
					<li>Individuelle Abmessungen</li>
					<li>Bewahrt Seitenverhätnis, wenn nur eine Abmessung angegeben wird</li>
					<li>Mehrere bearbeitete Versionen, falls das Größenverhältnis der Zieldatei maßgeblich von dem
					der Quelldatei abweicht</li>
					<li>Funktioniert offline</li>
					<li>Bequeme Download-Möglichkeit (volle Unterstützung bei Firefox und Chrome)</li>
					</ul>
				</div>
			</div>
			<form id="img_upload" onsubmit="crop('img','style_selection', 'width', 'height', 'inprogress', 'result'); return false">
			<label for="img">Ich möchte <br /></label><input type="file" id="img" multiple><br />
			<label for="style_selection">auf<br /></label><select id="style_selection"><br />
				<option id="news" value="news" selected>"Nachrichten"-Größe</option>
				<option id="medium" value="medium">halbe Seitenbreite</option>
				<option id="large" value="large">ganze Seitenbreite</option>
				<option id="custom" value="custom">individuelle Größe...</option>
			</select><br />
			<div id="custom_form">
				<label for="width">Breite</label><input type="number" id="width">
				<label for="height">Höhe</label><input type="number" id="height" title="Falls leer, wird das Seitenverhältnis beibehalten.">
			</div><br />
			<input type="submit" value="zuschneiden">
			</form>
			<div id="inprogress">Bilder werden vorbereitet...</div>
			<div id="result" title="Zum Speichern bitte anklicken"></div>
		</div>
		<script type="text/javascript">
			toggleCustom();
			document.getElementById('info').style.display = "none";
			document.getElementById('impressum').style.display = "none";
			document.getElementById('style_selection').addEventListener('change',toggleCustom);
			function toggleCustom() {
				if ( document.getElementById('style_selection').value == "custom" ) {
					document.getElementById('custom_form').style.display = "inline";
				} else {
					document.getElementById('custom_form').style.display = "none";
				} 
			}
			function toggleEl(el) {
				if ( document.getElementById(el).style.display == "none" ) {
					document.getElementById(el).style.display = "inline";
				} else {
					document.getElementById(el).style.display = "none";
				} 
			}
		</script>
	</body>
